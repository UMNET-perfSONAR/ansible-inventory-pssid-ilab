# perfsonar.yml main perfSONAR config

- name: bootstrap
  hosts:
    - pSSID-testpoints
  vars:
    - uids:
      #- abifox
      - epcjr
      - isaiyara
    #- address: 198.111.224.154
    #- gateway: 198.111.224.145

  tasks:
    - name: Include vars bootstrap_vars.yml
      include_vars:
        file: ../inventory/group_vars/all/bootstrap_vars.yml
        name: bootstrap_vars
    
    - name: with_together
      debug:
        msg: "{{ item }} - {{ bootstrap_vars.users[item] }}"
      with_items: "{{ uids }}"
    
    - name: hosts.allow for bastion jumpboxes
      lineinfile:
        path: /etc/hosts.allow
        line: "sshd: 141.211.160.28"

    - name: hosts.deny sshd for everything else
      lineinfile:
        path: /etc/hosts.deny
        line: "sshd: all"

    - name: add users
      user:
        name: "{{ item }}"
      with_items: "{{ uids }}"

# please change to use .yml file
    - name: auth keys
      authorized_key:
        user: "{{ item }}"
        key: "{{ bootstrap_vars.users[item] }}"
      with_items: "{{ uids }}"
      ignore_errors: yes
